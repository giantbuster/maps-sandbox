<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html {
            height: 100% ;
            font-family: helvetica;
        }
        body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
        }
        #map-canvas{
            height: 250px;
            width: 250px;
            background: #e1e1e1;
            display: inline-block;
        }

        #streetview-images div{
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-size: cover;
            background-position: 50% 80%;
        }
        #panel{
            position: fixed;
            color: white;
            top: 0px;
            left: 0px;
            position: relative;
            z-index: 11;
            width: 250px;
            height: 250px;
            background: rgba(0, 0, 0, 0.3);
        }
        .current-image{
            z-index: 10;
        }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlPz-ZPQjYceZvOJInQzWbIHB2EkRWDJY&sensor=false"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src=""></script>
    <script type="text/javascript">
        var streetView = null;

        var markerArray = [];
        var currImage = 0;

        function StreetViewGallery(){
            var webService = new google.maps.StreetViewService();
            var directionsDisplay = new google.maps.DirectionsRenderer();
            var directionsService = new google.maps.DirectionsService();
            var imgOptions = {
                WIDTH: 640,
                HEIGHT: 640,
                FOV: 90,
                PITCH: 25
            }
            var API_KEY = 'AIzaSyDlPz-ZPQjYceZvOJInQzWbIHB2EkRWDJY';
            var DIV_ID = 'streetview-images';
            var RADIUS = 10;
            var LIMIT = 5;
            
            //Finds directions from pointA to pointB using Google Maps API
            function findRoute() {
                var start = document.getElementById('start').value;
                var end = document.getElementById('end').value;
                var request = {
                    origin: start,
                    destination: end,
                    travelMode: google.maps.TravelMode.DRIVING
                };
                directionsService.route(request, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        resetStreetViews();
                        directionsDisplay.setMap(googleMap);
                        directionsDisplay.setDirections(response);
                        console.log(directionsDisplay);
                        findStreetViews(response.routes[0].overview_path);
                    }
                });
            }

            //Given an array of points, goes through them and finds panoramic images
            function findStreetViews(pointsArray){
                var currentIteration = 0;
                var panoArray = [];
                for (var i = 0; i < (pointsArray.length > LIMIT ? LIMIT : pointsArray.length); i++){
                    findPanorama(pointsArray[i], i, pointsArray.length, panoArray, currentIteration);
                }

                //Tries to find a single panoramic image at a point, and puts it into the specified index
                function findPanorama(point, index, pointsArrayLength, panoArray){
                    webService.getPanoramaByLocation(point, RADIUS, function(result, status){
                        currentIteration++;
                        panoArray[index] = result;

                        //If we're on the last iteration, parse the entire array
                        if (currentIteration == (pointsArrayLength > LIMIT ? LIMIT : pointsArrayLength)){
                            parsePanoramaArray(panoArray);
                        }
                    });
                }
            }

            //Given an array of Street View Panorama points, remove any null elements,
            //generate headings for each point (for the URL), generate HTML tags with ,
            //and display the HTML.
            function parsePanoramaArray(panoArray){
                trimNull(panoArray);
                getAllHeadings(panoArray);
                markerArray = getAllMarkers(panoArray);
                var htmlArray = getAllStreetViewHTML(panoArray);
                displayHTML(htmlArray, DIV_ID);
            }

            //Removes null elements from an array
            function trimNull(array){
                for(var i = 0; i<array.length; i++) {
                    if(array[i] == null) {
                        array.splice(i--, 1);
                    }
                }
            }

            //Calculates heading between i and i+1 for every google Point in an array
            function getAllHeadings(array){
                var heading = 0;
                for (var i = 0; i<array.length; i++){
                    if (array[i] && array[i+1]) heading = calculateHeading(array[i], array[i+1]);
                    array[i].heading = heading;
                }
            }

            //Given two Google Map Points, calculates heading from pointA to pointB
            function calculateHeading(pointA, pointB){
                return google.maps.geometry.spherical.computeHeading(pointA.location.latLng, pointB.location.latLng);
            }

            //Given an array of Google Maps points, creates an array of markers
            function getAllMarkers(array){
                var markers = [];
                for (var i = 0; i < array.length; i++){
                    markers[i] = createMarker(array[i].location.latLng);
                }
                return markers;
            }

            //Given a latLng, creates a marker (not on a map)
            function createMarker(latLng){
                var marker = new google.maps.Marker({
                    position: latLng,
                });
                return marker;
            }

            //Given an array of HTML, adds the HTML into the specified ID
            function displayHTML(array, id){
                for (var i = 0; i < array.length; i++){
                    document.getElementById(id).innerHTML += array[i];
                    //Insert CSS class for first streetview
                    if (i==0){
                        document.getElementById(id).firstChild.className += 'current-image';
                    }
                }
            }

            //Given an array of street view panorama points, creates an array 
            //of HTML with those street view images (div tags with image as background)
            function getAllStreetViewHTML(array){
                var htmlArray = [];
                for (var i = 0; i<array.length; i++){
                    htmlArray[i] = generateStreetViewHTML(array[i]);
                }
                return htmlArray;
            }
            
            //Takes a single Google Maps Point and generates
            //a div with the streetview image as its background.
            function generateStreetViewHTML(point){
                var src = streetViewSrc(point);
                var html = divWithBackground(src);
                return html;
            }

            //Take a Google Maps Point for a street view image and 
            //generates a URL for it, using location, heading, size, fov, pitch, and key. 
            function streetViewSrc(point){
                var src = "http://maps.googleapis.com/maps/api/streetview?location="+
                            point.location.latLng.toUrlValue()+
                            "&heading="+
                            point.heading+
                            "&size="+
                            imgOptions.WIDTH+"x"+imgOptions.HEIGHT+
                            "&fov="+
                            imgOptions.FOV+
                            "&pitch="+
                            imgOptions.PITCH+
                            "&sensor=false&key="+
                            API_KEY;
                return src;
            }

            //Given a url source, puts it in a div as the background image
            function divWithBackground(src){
                var div = '<div style="background-image: url(\''+src+'\');"></div>';
                return div;
            }

            //On form submit, resets images and variables
            function resetStreetViews(){
                document.getElementById('streetview-images').innerHTML = "";
                directionsDisplay.setMap(null);
                currImage = 0;
                markerArray = [];
            }

            //Calculate route on initialization
            findRoute();
        };

        
        var googleMap;
        //Initializes Google Maps and Directions
        function initialize() {
            var directionsDisplay = new google.maps.DirectionsRenderer();
            var sanFrancisco = new google.maps.LatLng(37.774950000000004, -122.41929);
            var mapOptions = {
                zoom: 10,
                center: sanFrancisco
            }
            googleMap = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            directionsDisplay.setMap(googleMap);
        }

        //initialize the map
        google.maps.event.addDomListener(window, 'load', initialize);

        //Read key input for changing images
        $( window ).keyup(function(e) {
            if (e.keyCode == 38 || e.keyCode == 40) {
                var curr = $(".current-image");
                //Move up
                if (e.keyCode==38){
                    if ( curr.prev().length ){
                        markerArray[currImage--].setMap(null);
                        markerArray[currImage].setMap(googleMap);
                        // googleMap.setCenter(markerArray[currImage].getPosition());
                        curr.removeClass("current-image");
                        curr.prev().addClass("current-image");
                    } 
                //Move down
                } else if (e.keyCode==40){
                    if ( curr.next().length ){
                        markerArray[currImage++].setMap(null);
                        markerArray[currImage].setMap(googleMap);
                        // googleMap.setCenter(markerArray[currImage].getPosition());
                        curr.removeClass("current-image");
                        curr.next().addClass("current-image");
                    } 
                }
            }
        });
    </script>
</head>

<body>
    <div id="panel">
            <!-- 1401 Golden Gate Bridge, San Francisco, CA 94129
            Golden Gate Bridge & El Camino Real, Sausalito, CA 94965 -->
            <b>Start: </b>
            <input type="text" id="start" value="grand central terminal">
            <br>
            <b>End: </b>
            <input type="text" id="end" value="empire state building">
            <br>
            <input type="button" value="Go" onclick="StreetViewGallery();">
        <div id="map-canvas"></div>
    </div>
    <div class="markers"></div>
    <div id="streetview-images"></div>
</body>
</html>